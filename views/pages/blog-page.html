{{ define "top-embeds" }}
<script>
    let galleryMap = new Map();
    let map;

    window.addEventListener('popout', (e) => {
        map.remove();
        galleryMap.forEach((_, g, m) => {
            g.destroy();
        });
        galleryMap.clear();
        map = null;
        galleryMap = null;
    }, {once: true});
</script>
{{ end }}

{{ define "body" }}
<div class="bg-background-light flex flex-col inset-shadow px-8 py-4 overflow-y-auto">
    {{ .ParsedMarkdown }}
{{- if .MapLocationX }}
    <hr class="border-t-3 border-dotted border-main-dark mt-1 mb-2 w-[80%] ml-auto mr-auto">
    <div id="map-container" class="relative p-1 flex-none ml-auto mr-auto w-[60%] ar-lt-1.1:w-[80%] h-[40dvh] ar-lt-1.1:h-[30dvh]"></div>
    <hr class="border-t-3 border-dotted border-main-dark mt-1 mb-2 w-[80%] ml-auto mr-auto">

    <script>
        function initLocationMap(id, x, y, relativeErrorMeters = 0) {
            map = L.map(id).setView([x, y], 8);

            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            if (relativeErrorMeters != 0) {
                var circle = L.circle([x, y], {
                    color: '#8a9d8a',
                    fillColor: '#8a9d8a',
                    fillOpacity: 0.15,
                    radius: relativeErrorMeters
                }).addTo(map);
            }

            var marker = L.marker([x, y], {
                title: '{{ .Title }}',
            }).addTo(map)
                .bindPopup('<span><b>{{ .Title }}</b><br><a href="https://www.openstreetmap.org/#map=13/{{ .MapLocationX }}/{{ .MapLocationY }}">{{ .MapLocationX }}, {{ .MapLocationY }}</a></span>')
                .openPopup();
        }

        document.addEventListener('htmx:afterRequest', (e) => {
            if (e.detail.target.id == 'general-page-body') {
                initLocationMap(
                    'map-container',
                    {{ .MapLocationX }},
                    {{ .MapLocationY }},
                    {{ .MapLocationAreaMeters }}
                );
            }
        }, {once: true});
    </script>
{{- end }}
</div>
{{ end }}

{{ define "footer" }}
<div hx-get="/api/v1/like" hx-target="this" hx-swap="outerHTML" hx-trigger="load"></div>
{{ end }}

{{ define "bottom-embeds" }}
<script>
    let galleryResizeTimeout;

    function resizeCb() {
        clearTimeout(galleryResizeTimeout);
        galleryResizeTimeout = setTimeout(() => {
            if (map !== undefined) {
                map.invalidateSize();
            }
            var oldGalleryMap = new Map(galleryMap);
            oldGalleryMap.forEach((createFunc, g, map) => {
                galleryMap.delete(g);
                g.destroy();
                createFunc();
            });
        }, 300);
    }

    window.addEventListener('resize', resizeCb);

    document.addEventListener('popout', (e) => {
        window.removeEventListener('resize', resizeCb);
        galleryResizeTimeout = null;
    });
</script>
{{ end }}
